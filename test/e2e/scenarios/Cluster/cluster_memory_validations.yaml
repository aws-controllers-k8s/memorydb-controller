id: "CLUSTER_CREATE_UPDATE_MEMORY_VALIDATION"
description: "In this test we validate Memory in a cluster"
#marks:
#  - slow
#  - blocked
steps:
  - id: "CREATE_CLUSTER"
    description: "Create a Cluster"
    create:
      apiVersion: $CRD_GROUP/$CRD_VERSION
      kind: Cluster
      metadata:
        name: cluster$RANDOM_SUFFIX
      spec:
        name: cluster$RANDOM_SUFFIX
        nodeType: db.t4g.medium
        aclName: open-access
        numShards: 2
        snapshotName: maxmemory
    wait:
      status:
        conditions:
          ACK.ResourceSynced:
            status: "True"
            timeout: 7200

  - id: "PERFORM_SCALE_DOWN"
    description: "Perform scale down"
    patch:
      apiVersion: $CRD_GROUP/$CRD_VERSION
      kind: Cluster
      metadata:
        name: cluster$RANDOM_SUFFIX
      spec:
        nodeType: db.t4g.small
    wait:
      status:
        conditions:
          ACK.Terminal:
            status: "True"
            timeout: 7200

  - id: "PERFORM_SCALE_IN"
    description: "Perform scale in"
    patch:
      apiVersion: $CRD_GROUP/$CRD_VERSION
      kind: Cluster
      metadata:
        name: cluster$RANDOM_SUFFIX
      spec:
        nodeType: db.t4g.medium
        numShards: 1
    wait:
      status:
        conditions:
          ACK.Terminal:
            status: "True"
            timeout: 1800

  - id: "RESET_THE_CONDITION"
    description: "Reset to original state"
    patch:
      apiVersion: $CRD_GROUP/$CRD_VERSION
      kind: Cluster
      metadata:
        name: cluster$RANDOM_SUFFIX
      spec:
        nodeType: db.t4g.medium
        numShards: 2
    wait:
      status:
        conditions:
          ACK.ResourceSynced:
            status: "True"
            timeout: 1800

  - id: "PERFORM_SCALE_UP_AND_SCALE_IN"
    description: "Perform scale up and scale in"
    patch:
      apiVersion: $CRD_GROUP/$CRD_VERSION
      kind: Cluster
      metadata:
        name: cluster$RANDOM_SUFFIX
      spec:
        nodeType: db.r6g.large
        numShards: 1
    wait:
      status:
        conditions:
          ACK.ResourceSynced:
            status: "True"
            timeout: 7200

  - id: "DELETE_CLUSTER"
    description: "Delete the cluster"
    delete:
      apiVersion: $CRD_GROUP/$CRD_VERSION
      kind: Cluster
      metadata:
        name: cluster$RANDOM_SUFFIX